name: Release

permissions:
    contents: write
    id-token: write

on:
    pull_request:
        types: [closed]
        branches: [main]
    workflow_dispatch:

concurrency:
    group: release
    cancel-in-progress: false

jobs:
    check-changesets:
        name: Check for changesets
        runs-on: ubuntu-latest
        if: |
            github.event_name == 'workflow_dispatch' ||
            (github.event_name == 'pull_request'
             && github.event.pull_request.merged == true
             && contains(github.event.pull_request.labels.*.name, 'release'))
        outputs:
            has-changesets: ${{ steps.check.outputs.has-changesets }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0

            - name: Check for changesets
              id: check
              run: |
                  if [ ! -d ".changeset" ] || [ -z "$(ls -A .changeset/*.md 2>/dev/null | grep -v README.md)" ]; then
                    echo "No changesets found. Cannot proceed with release."
                    echo "Please ensure your PR includes a changeset file."
                    echo "has-changesets=false" >> "$GITHUB_OUTPUT"
                  else
                    echo "Found changesets to process"
                    echo "has-changesets=true" >> "$GITHUB_OUTPUT"
                  fi

    version-bump:
        name: Bump version and commit to main
        needs: check-changesets
        runs-on: ubuntu-latest
        if: needs.check-changesets.outputs.has-changesets == 'true'
        outputs:
            committed: ${{ steps.commit-version-bump.outputs.committed }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Enable corepack
              run: corepack enable

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24.x'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Update version and changelog
              run: pnpm changeset version
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Update lockfile
              run: pnpm install

            - name: Commit version bump and lockfile
              id: commit-version-bump
              run: |
                  git add -A
                  if git diff --staged --quiet; then
                    echo "No changes to commit"
                    echo "committed=false" >> "$GITHUB_OUTPUT"
                  else
                    git commit -m "chore: update version and changelog [version bump]"
                    git push origin main
                    echo "committed=true" >> "$GITHUB_OUTPUT"
                  fi

    publish:
        name: Publish to npm
        needs: version-bump
        runs-on: ubuntu-latest
        if: needs.version-bump.outputs.committed == 'true'
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: main
                  fetch-depth: 0

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Enable corepack
              run: corepack enable

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24.x'
                  cache: 'pnpm'
                  registry-url: 'https://registry.npmjs.org'

            - name: Check version
              id: check-package-version
              uses: PostHog/check-package-version@v2.1.0

            - name: Install and build
              if: steps.check-package-version.outputs.is-new-version == 'true'
              run: pnpm install --frozen-lockfile && pnpm build

            - name: Tag repository
              if: steps.check-package-version.outputs.is-new-version == 'true'
              run: |
                  git tag -a "v${{ steps.check-package-version.outputs.committed-version }}" -m "v${{ steps.check-package-version.outputs.committed-version }}"

            - name: Publish to npm
              if: steps.check-package-version.outputs.is-new-version == 'true'
              run: pnpm publish --access public --no-git-checks
              env:
                  NPM_CONFIG_PROVENANCE: true
                  NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Push tag to GitHub
              if: steps.check-package-version.outputs.is-new-version == 'true'
              run: |
                  git push origin "v${{ steps.check-package-version.outputs.committed-version }}"

            - name: Create GitHub release
              if: steps.check-package-version.outputs.is-new-version == 'true'
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  LAST_CHANGELOG_ENTRY=$(awk -v defText="see CHANGELOG.md" '/^## /{if (flag) exit; flag=1} flag && /^##$/{exit} flag; END{if (!flag) print defText}' CHANGELOG.md)
                  gh api \
                    --method POST \
                    -H "Accept: application/vnd.github+json" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    /repos/${{ github.repository }}/releases \
                    -f tag_name="v${{ steps.check-package-version.outputs.committed-version }}" \
                    -f target_commitish='main' \
                    -f name="v${{ steps.check-package-version.outputs.committed-version }}" \
                    -f body="$LAST_CHANGELOG_ENTRY" \
                    -F draft=false \
                    -F prerelease=false \
                    -F generate_release_notes=false
